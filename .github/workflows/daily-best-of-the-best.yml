name: "üèÜ Daily Best-of-the-Best Blog"

on:
  schedule:
    - cron: "0 4 * * *"  # Every day at 04:00 UTC (05:00 CET)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  best-of-the-best:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y graphviz fonts-dejavu-core
          echo "‚úÖ System dependencies installed (graphviz, fonts)"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r scripts/requirements.txt
          echo "‚úÖ Python dependencies installed"

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium
          echo "‚úÖ Playwright browser installed"

      - name: ‚öôÔ∏è Install Ollama (Linux)
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

      - name: üß† Start Ollama & pull llama3 model
        env:
          OLLAMA_HOST: "127.0.0.1"
          OLLAMA_PORT: "11434"
        run: |
          ollama serve >/tmp/ollama.log 2>&1 &
          # Wait for server to be ready
          for i in {1..30}; do
            if curl -fsS "http://127.0.0.1:11434/api/tags" >/dev/null 2>&1; then
              echo "‚úÖ Ollama is up"
              break
            fi
            echo "‚è≥ Waiting for Ollama..."
            sleep 2
          done
          echo "‚¨áÔ∏è Pulling llama3:8b..."
          ollama pull llama3:8b
          echo "‚úÖ Model ready"

      - name: Create required directories
        run: |
          mkdir -p blog/api
          mkdir -p blog/posts
          mkdir -p data
          mkdir -p assets/images
          mkdir -p logs

      - name: üèÜ Generate daily Best-of-the-Best blog post
        env:
          # Ollama configuration
          NEWS_LLM_MODEL: "ollama/llama3:8b"
          OLLAMA_HOST: "http://127.0.0.1:11434"

          # LiteLLM timeout settings (prevent long hangs, enable fast retries)
          LITELLM_REQUEST_TIMEOUT: "120"
          LITELLM_NUM_RETRIES: "2"

          # Image generation (optional - will create placeholders if not set)
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}

          # Optional: other LLM providers (if you switch from Ollama)
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          WATSONX_APIKEY: ${{ secrets.WATSONX_APIKEY }}
          WATSONX_URL: ${{ secrets.WATSONX_URL }}
          WATSONX_PROJECT_ID: ${{ secrets.WATSONX_PROJECT_ID }}
        run: |
          echo "üöÄ Starting blog generation with v3.6..."
          python scripts/generate_daily_blog.py
          echo "‚úÖ Blog generation complete"

      - name: üõ°Ô∏è Check for duplicate topics
        run: |
          # Get the newest post
          LATEST_POST=$(ls -t blog/posts/*.md 2>/dev/null | grep -v index | head -1)
          if [ -z "$LATEST_POST" ]; then
            echo "‚ö†Ô∏è  No post found, skipping duplicate check"
            exit 0
          fi

          # Extract topic_id
          TOPIC_ID=$(grep "^topic_id:" "$LATEST_POST" | head -1 | sed 's/topic_id: *"\?\([^"]*\)"\?/\1/')

          # Check last 5 posts for same topic_id
          PREV_POSTS=$(ls -t blog/posts/*.md 2>/dev/null | grep -v index | tail -n +2 | head -5)
          for post in $PREV_POSTS; do
            PREV_ID=$(grep "^topic_id:" "$post" | head -1 | sed 's/topic_id: *"\?\([^"]*\)"\?/\1/')
            if [ "$PREV_ID" = "$TOPIC_ID" ]; then
              echo "‚ùå DUPLICATE TOPIC DETECTED: $TOPIC_ID"
              echo "   Latest: $(basename "$LATEST_POST")"
              echo "   Previous: $(basename "$post")"
              exit 1
            fi
          done

          echo "‚úÖ No duplicate topics found (current topic: $TOPIC_ID)"

      - name: Verify blog post was created
        run: |
          echo "üîç Verifying blog post output..."

          # Check if any new blog post exists (excluding index.md)
          LATEST_POST=$(ls -t blog/posts/*.md 2>/dev/null | grep -v index | head -1)

          if [ -z "$LATEST_POST" ]; then
            echo "‚ùå No blog posts found!"
            echo "   Expected format: blog/posts/YYYY-MM-DD-*.md"
            ls -la blog/posts/ || true
            exit 1
          fi

          echo "‚úÖ Blog post found: $(basename "$LATEST_POST")"

          # Validate Jekyll front matter
          if ! head -1 "$LATEST_POST" | grep -q "^---$"; then
            echo "‚ùå Invalid Jekyll front matter"
            head -5 "$LATEST_POST"
            exit 1
          fi

          # Check word count
          WORD_COUNT=$(grep -v "^---" "$LATEST_POST" | wc -w | xargs)
          echo "   Words: $WORD_COUNT"

          if [ "$WORD_COUNT" -lt 100 ]; then
            echo "‚ùå Post too short: $WORD_COUNT words"
            exit 1
          fi

          if [ "$WORD_COUNT" -lt 800 ]; then
            echo "‚ö†Ô∏è  Warning: Post seems short (< 800 words, has $WORD_COUNT)"
          fi

          # Check for code blocks
          CODE_BLOCKS=$(grep -c '```python' "$LATEST_POST" || echo "0")
          echo "   Code blocks: $CODE_BLOCKS"

          # Check for friendly intro/outro (v3.0 feature)
          if grep -q "Hello everyone!" "$LATEST_POST"; then
            echo "   Friendly intro: ‚úì"
          fi

          if grep -q "Congratulations!" "$LATEST_POST"; then
            echo "   Motivating outro: ‚úì"
          fi

          echo ""
          echo "üñºÔ∏è  Checking generated assets..."

          # Check for topic-specific images
          if ls assets/images/20*/header-*.jpg 1> /dev/null 2>&1; then
            NEW_IMAGES=$(find assets/images/20*/ -type f 2>/dev/null | wc -l)
            echo "‚úÖ Generated $NEW_IMAGES topic-specific images"
            find assets/images/20*/ -type f -exec basename {} \; | sed 's/^/   ‚Ä¢ /'
          else
            echo "‚ö†Ô∏è  No topic-specific images found (placeholders may be used)"
          fi

          echo ""
          echo "‚úÖ Post validation passed"

      - name: üîÅ Rebuild blog index & API feeds
        run: |
          python blog/generate_index.py
          python export_data_feeds.py

      - name: üìä Quality report & coverage check
        run: |
          echo "üìä Quality report..."

          LATEST_POST=$(ls -t blog/posts/*.md 2>/dev/null | grep -v index | head -1)

          if [ -n "$LATEST_POST" ]; then
            # Check for potential issues
            ISSUES=0

            if ! grep -q '```python' "$LATEST_POST"; then
              echo "‚ö†Ô∏è  No code examples found"
              ISSUES=$((ISSUES + 1))
            fi

            if grep -qi "rapidly evolving" "$LATEST_POST"; then
              echo "‚ö†Ô∏è  AI buzzwords detected"
              ISSUES=$((ISSUES + 1))
            fi

            WORD_COUNT=$(grep -v "^---" "$LATEST_POST" | wc -w | xargs)
            if [ "$WORD_COUNT" -lt 500 ]; then
              echo "‚ö†Ô∏è  Short post (< 500 words)"
              ISSUES=$((ISSUES + 1))
            fi

            if [ "$ISSUES" -eq 0 ]; then
              echo "‚úÖ No quality issues detected"
            fi
          fi

          # Coverage stats
          if [ -f "data/blog_coverage.json" ]; then
            COVERAGE_COUNT=$(python -c "import json; print(len(json.load(open('data/blog_coverage.json'))))" 2>/dev/null || echo "?")
            echo ""
            echo "üìà Coverage Stats:"
            echo "   Total posts: $COVERAGE_COUNT"
            echo "   Coverage file: data/blog_coverage.json"
          else
            echo "‚ö†Ô∏è  No coverage file found at data/blog_coverage.json"
            echo "   This may cause topic repetition!"
          fi

          echo ""
          echo "‚úÖ Quality check complete"

      - name: Commit new blog + assets + updated feeds
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üèÜ Daily Best-of-the-Best blog with topic-specific images"
          file_pattern: |
            blog/posts/*.md
            blog/posts/index.json
            blog/api/*.json
            blog/api/*.xml
            data/blog_coverage.json*
            assets/images/**/*.jpg
            assets/images/**/*.png
          commit_user_name: "BestOfTheBestBot"
          commit_user_email: "actions@github.com"
          commit_options: '--no-verify'

      - name: üìä Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: blog-generation-logs
          path: |
            logs/blog_generation.log
            /tmp/ollama.log
          retention-days: 7